<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/firebase-element/firebase-collection.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../vote-controls/vote-controls.html">
<link rel="import" href="../vote-login/vote-login.html">


<dom-module id="vote-view">
    <template>
        <paper-material>
            <!-- <paper-card heading="Card Title">
                <div class="card-content">{{isAuthorized(user.isAuth)}}</div>
                <div class="card-actions">
                    <paper-button on-click="changeAdmin">Simulate Log out</paper-button>
                </div>
            </paper-card> -->
        </paper-material>

        <paper-material>

            <!-- <template> -->
                <!-- <template> -->
                <!-- </template> -->
            <!-- </template> -->

            <!-- 'fire()' method attached created the event 'add-name'. 'add-to-name' listens to it and fires addName -->
            <template is="dom-if" if="{{isAuthorized(user.isAuth)}}">
                <vote-controls
                    votes={{votes}}
                    user={{isAuthorized(user.isAuth)}}
                    on-change-vote-input="updateCandidateInput"
                    on-vote-add="updateCandidatePartial"
                    on-vote-remove="updateCandidatePartial"
                ></vote-controls>
            </template>
        </paper-material>

            <template is="dom-if" if="{{!isAuthorized(user.isAuth)}}">
                <paper-material>
                    <vote-login on-get-login="passwordCheck" user={{isAuthorized(user.isAuth)}}><vote-login>
                </paper-material>
            </template>

    </template>

    <script>

        (function() {
            Polymer({
                is: 'vote-view',

                properties: {
                    dbString: 'https://polypol.firebaseio.com/',
                    votes: {
                        type: Array
                    }
                },

                passwordCheck: function(e){
                    var password = e.detail.password;

                    if(password === 'enricosindaco'){
                        if(this.user.isAuth === false){
                            this.set('user.isAuth', true);
                        }
                    }
                    console.log(e.detail.password);
                },

                isAuthorized: function(){
                    return this.user.isAuth;
                },

                changeAdmin: function() {
                    if(this.user.isAuth === true){
                        this.set('user.isAuth', false);
                    }else {
                        this.set('user.isAuth', true);
                    }
                },

                updateCandidatePartial: function(e) {
                    var dbTarget = new Firebase(this.properties.dbString + e.detail.section + '/' + e.detail.candidate);

                    dbTarget.transaction(function(currentCandidate) {
                        if (e.detail.action == 'add') {
                            return currentCandidate + 1;
                        }else if (e.detail.action == 'remove') {
                            return currentCandidate - 1;
                        }
                    });

                    this.updateSectionTotal(e.detail.section, e.detail.action);
                    this.updateCandidateMainTotal(e.detail.action, e.detail.candidate);
                    this.updateMainTotal(e.detail.action);
                },

                updateSectionTotal: function (section, action, amount) {
                    var dbTarget = new Firebase(this.properties.dbString + section + '/total');
                    var val = amount > 0 && !NaN ? amount : 1;
                    console.log(val);

                    dbTarget.transaction(function(currentTotal) {
                        if (action == 'add') {
                            return currentTotal + val;
                        }else if (action == 'remove') {
                            return currentTotal - val;
                        }
                    });
                },

                updateMainTotal: function (action, amount) {
                    var dbTarget = new Firebase( this.properties.dbString + 'maintotal');
                    var val = amount > 0 && !NaN ? amount : 1;

                    dbTarget.transaction(function(currentMaintotal) {
                        if (action == 'add') {
                            return currentMaintotal + val;
                        }else if (action == 'remove') {
                            return currentMaintotal - val;
                        }
                    });
                },

                updateCandidateMainTotal: function (action, candidate, amount) {
                    var dbTarget = new Firebase(this.properties.dbString + candidate + 'total');
                    var valueTarget = 'current' + candidate.charAt(0).toUpperCase() + candidate.slice(1) + 'total';
                    var val = amount > 0 && !NaN ? amount : 1;

                    dbTarget.transaction(function(valueTarget) {
                        if (action == 'add') {
                            return valueTarget + val;
                        }else if (action == 'remove') {
                            return valueTarget - val;
                        }
                    });
                },

                updateCandidateInput: function (e) {
                    var dbTarget = new Firebase(this.properties.dbString + e.detail.section);
                    var valueObject = {};
                    var newValue = Number(e.detail.value);
                    var amount = Number(e.detail.amount);
                    console.log(e.detail);

                    if (newValue > 0 && !NaN || amount > 0 && !NaN) {
                        valueObject[e.detail.candidate] = Number(e.detail.value);
                        dbTarget.update(valueObject);
                    } else {
                        console.log('no vote added');
                    }

                    this.updateSectionTotal(e.detail.section, e.detail.action, e.detail.amount);
                    this.updateCandidateMainTotal(e.detail.action, e.detail.candidate, e.detail.amount);
                    this.updateMainTotal(e.detail.action, e.detail.amount);

                }

            });
        })();
    </script>

</dom-module>
